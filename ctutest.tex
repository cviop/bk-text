% arara: pdflatex: { synctex: yes }
% arara: makeindex: { style: ctuthesis }
% arara: bibtex

% The class takes all the key=value arguments that \ctusetup does,
% and a couple more: draft and oneside
\documentclass[twoside]{ctuthesis}
\usepackage{float}
\usepackage{subcaption}
\ctusetup{
	preprint = \ctuverlog,
%	mainlanguage = english,
%	titlelanguage = czech,
	mainlanguage = czech,
	otherlanguages = {slovak,english},
	title-czech = {Přenos telemetrických dat z meteorologického balónu},
	title-english = {Telemetric Data Transmission from Meteorological Balloon},
	subtitle-czech = {},
	subtitle-english = {},
	doctype = B,
	faculty = F3,
	department-czech = {Katedra elektromagnetického pole},
	department-english = {Department of electromagnetic field},
	author = {Jakub Dvořák},
	supervisor = {Ing. Tomáš Kořínek, Ph.D.},
	supervisor-address = {Technická 2, \\ Praha 6},
	supervisor-specialist = {},
	fieldofstudy-english = {},
	subfieldofstudy-english = {},
	fieldofstudy-czech = {},
	subfieldofstudy-czech = {},
	keywords-czech = {slovo, klíč},
	keywords-english = {word, key},
	day = 20,
	month = 5,
	year = 2022,
	specification-file = {zav_prace.pdf},
%	front-specification = true,
%	front-list-of-figures = false,
%	front-list-of-tables = false,
%	monochrome = true,
%	layout-short = true,
}

\ctuprocess

\addto\ctucaptionsczech{%
	\def\supervisorname{Vedoucí}%
	\def\subfieldofstudyname{Studijní program}%
}

\ctutemplateset{maketitle twocolumn default}{
	\begin{twocolumnfrontmatterpage}
		\ctutemplate{twocolumn.thanks}
		\ctutemplate{twocolumn.declaration}
		\ctutemplate{twocolumn.abstract.in.titlelanguage}
		\ctutemplate{twocolumn.abstract.in.secondlanguage}
		\ctutemplate{twocolumn.tableofcontents}
		\ctutemplate{twocolumn.listoffigures}
	\end{twocolumnfrontmatterpage}
}

% Theorem declarations, this is the reasonable default, anybody can do what they wish.
% If you prefer theorems in italics rather than slanted, use \theoremstyle{plainit}
\theoremstyle{plain}
\newtheorem{theorem}{Theorem}[chapter]
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{example}[theorem]{Example}
\newtheorem{conjecture}[theorem]{Conjecture}

\theoremstyle{note}
\newtheorem*{remark*}{Remark}
\newtheorem{remark}[theorem]{Remark}

\setlength{\parskip}{5ex plus 0.2ex minus 0.2ex}

% Abstract in Czech
\begin{abstract-czech}
Aaaabstrakt

\end{abstract-czech}

% Abstract in English
\begin{abstract-english}
Abstract
	
\end{abstract-english}

% Acknowledgements / Poděkování
\begin{thanks}
Děkuji vedoucímu Tomáši Kořínkovi za cenné rady a pomoc při realizaci práce. Děkuji Ing. Martinu Motlovi za pomoc s vypouštěním sondy. (tmobile tracker)

\end{thanks}

% Declaration / Prohlášení
\begin{declaration}
	Prohlašuji, že jsem tuto práci vypracoval samostatně s~použitím literárních pramenů a~informací, které cituji a~uvádím v~seznamu použité literatury a~zdrojů informací.

V Praze, \ctufield{day}.~\monthinlanguage{title}~\ctufield{year}
\end{declaration}

% Only for testing purposes
\listfiles
\usepackage[pagewise]{lineno}
\usepackage{lipsum,blindtext}
\usepackage{mathrsfs} % provides \mathscr used in the ridiculous examples

\begin{document}

\maketitle

\chapter{Úvod}
tato práce ze zabývá...



\chapter{Cíl práce}
%výroba sondy schopná měřit podmínky ve tropo a posílat je na zem, měření příchozího signálu na zemi, vyrobit model šíření, změřit refrakci paprsku

	\section{Šíření vln ve troposféře}
	jak to funguje, na čem to závisí (přečíst literaturu)

	\section{Způsob řešení / návrh experimentu}
	výroba sondy, vypuštění spolu s čhmú, naměření dat z tropo a naměření dat na zemi a kombinace do modelu šíření vlny, anténa na trackeru, zjištění směrové charakteristiky, napočítat výkonovou bilanci -> výkon pro vysílání.
		\subsection{Měřená data}	
		jaká data budou měřena - podle literatury

	\section{Součásti experimentu}
	co je potřeba udělat - hw, firmware, sw, mechaniku, naměření dat, naměření charakteristik antény, zpracování dat. 


\chapter{Návrh systému}

	\section{Požadavky}
	Z důvodu dlouhé čekací doby na povolení vypuštění balónu, které vydává Úřad pro civilní letectví, je využito povolení, které má dlouhodobě sjednané ČHMÚ. Toto povolení se vztahuje na vypouštění volných balónů s užitečným zatížením do celkové hmotnosti 600~g. Denní sonda Vaisala RS41, kterou ČHMÚ posílá 3$\times$ denně, váží 84~g. Sonda vyvíjená v rámci této práce tedy musí splňovat požadavek na hmotnost do 516~g.

	Dalším požadavkem je posílání telemetrických údajů o poloze a ukládání zbylých naměřených dat na SD kartu umístěnou na palubě sondy. S ohledem na panující podmínky ve vyšších vrstvách zemské atmosféry musela být sonda schopna operovat za nízkého tlaku a teploty, které panují ve vyšších vrstvách atmosféry. Toto se vztahuje jak na mikročipy a senzory, tak na baterie, používané k napájení sondy. Další podmínkou bylo spolehlivé fungování v oblasti vysoké vlhkosti - oblačnosti a za deště. 

	Značná část GPS přijímačů je od výrobce zablokována pro použití ve výškách větších jak 10 km n. m. a bylo nutné zvolit přijímač, který dovoluje tzv. \textit{airborne mode}, ve kterém není omezena pracovní výška.

	Mechanická zástavba celé sondy musí splňovat požadavky pracovníků ČHMÚ, aby nedošlo k poničeni balónu a způsobení škod při dopadu na zem. Jelikož je sonda Vaisala RS41 pověšena pod sondu vznikající v rámci této práce, je nutné zajistit robustnost a zamezit odpojení sondy Vaisala, nebo rozpadu vyvíjené sondy.


	
	\section{Elektronika sondy}
	%součástky do -40, nízký tlak (bez elektrolytických kond.), dosah 40+ km
	V samotném návrhu elektroniky sondy bylo možné zvolit jednu ze dvou cest. Níže práce popisuje výhody, nevýhody a možné rizika každé z nich a cestu, která byla zvolena při řešení této práce.¨
		\subsection{Vývojové moduly}
		%snadné na vývoj a odladění, snadná změna zapojení pří psaní kódu
		V dnešní době existuje veliké množství mikročipů a MEMS čipů, které lze zakoupit ve formě modulů. Jedná se zpravidla o malé deky plošných spojů osazených konkrétními čipy s minimem potřebných součástek zajišťujících správné fungování. Zpravidla se jedná o blokovací kondenzátory umístěné v bezprostřední blízkosti čipů, poskytující elektrickou energii při rázovém odběru. Moduly mají vyvedené piny mikročipů na pinové lišty nacházející se na okraji PCB. 
		
		V případě mikroprocesoru se jedná o vývojový kit Nucleo od firmy \textit{ST Microelectronics}. Jedná se o PCB s mikroprocesorem a minimem součástek, nutných pro správné fungování procesoru. Součástí desky je také zdroj pro napájení čipu a programátor, kterým lze do mikroprocesou nahrát firmware. Jednotlivé piny mikroprocesoru jsou vyvedeny na pinové lišty na kraji desky a slouží ke snadnému propojení s moduly. 
		
		Výhodou tohoto řešení ve fázi vývoje je snadná záměna zapojení modulů a rychlé odstranění chyb způsobené chybným výběrem komunikačních pinů mikroprocesoru.

		Nevýhoda tohoto řešení je malá robustnost zapojení. Komunikační cesty mezi mikroprocesorem a senzory jsou zbytečné dlouhé, jelikož jsou podřízeny umístění pinů na pinových lištách. Další nevýhodou je nemožnost ovlivnit umístění blokovacích kondenzátorů u mikroprocesoru a nebo zvýšení jejich počtu. Vývojový kit Nucelo není tvořen s ohledem na malé rozměry a velikost PCB tohoto kitu ovlivňuje celkovou velikost elektroniky sondy.

		\subsection{Samostatná deska plošných spojů}
		Druhá cesta, kterou je možná se vydat při vývoji elektroniky v sondě je samostatná deska, která obsahuje jednotlivé mikročipy bez jejich modulů a separátních PCB. Díky tomu je možné minimalizovat vzdálenost mezi mikroprocesorem a senzory a zvýšit robustnost napájení čipů. Celková velikost desky je poté dána především schopnostmi návrháře. 
		
		Toto řešení je ale časové náročné a v případě způsobené chyby se špatně ladí. V případě zničení, nebo nefunkčnosti nějaké elektronické součástky je nutné její odpájení z desky, což může ohrozit komponenty v okolí. V případě modulů lze vyměnit modul samotný.

		Při řešení této práce byla zvolena cesta modulů. Důvodem bylo malé množství času neumožňující případné zdlouhavé odlaďování zapojení a také nedostatek součástek samotných. V tomto případě byly dostupnější senzory ve formě modulů a mikroprocesor ve formě vývojového kitu. 

		%kompaktní, spolehlivé, obtížné na debug, časové náročné
		

	\section{Firmware sondy}
	Firmware pro mikroprocesor v sondě zajišťuje správné čtení dat ze senzorů, jejich zpracování. Dále je nutné načítání data z GPS modulu a jejich rozdělení na dané zprávy a bloky informací využívaných pro určení pozice v prostoru. Všechny získané informace je poté nutno sešít do zprávy poslané telemetrií na zem a uložit na externí paměť. 

	Nutnou součástí firmwaru je také ošetření chybových stavů a možných errorů, vyvolaných chybným čtením dat a nebo fyzickými podmínkami prostředí.
	%čtení ze senzorů, parsování dat, posílání na zem a na sd kartu, odolnost, měření náklonu - jak?
		\subsection{Měření náklonu sondy}
		Acc, vektor mag pole, kalmánův filtr, co bylo použito

	
	\section{Pozemní stanice}
	Firmware pro mikroprocesor v pozemní stanici zodpovídá za správné dekódování přijatých telemetrických údajů. Firmware musí určit, která data jsou validní. Přijatá data je poté nutno zformátovat do zprávy určené pro anténní tracker, umístěný na střeše budovy FEL. Firmware musí být odolný vůči náhodným chybám způsobených přenosem na velkou vzdálenost. Příjem i posílání dat probíhá přes sériovou linku. 

	Elektronika pozemní stanice není vystavena extrémním podmínkám a není nutné řešit její odolnost vůči vnějším vlivům. 

	\section{Software pro zobrazení telemetrických údajů}
	Software určený pro příjem dat na počítači umístěném v automobilu jedoucí ve směru dopadu sondy. Software musí určit validní data a vyznačit GPS pozici sondy na mapě. Další funkcí softwaru je výpis souřadnic, výšky a rychlosti sondy a teploty okolí sondy. Data jdoucí do programu jsou posílána přes sériovou linkou z přijímače signálu vysílaného sondou. 


\chapter{Realizace}

	\section{Elektronika}
		\subsection{Testování modulů}
		měření odběru, energie pro poslání dat

		\subsection{Realizace elektroniky}
		\subsubsection{Napájení}
		Jako zdroj energie po dobu letu byly vybrány tužkové baterie \textit{Energizer ultimate lithium}. Dle technického listu (odkaz) jsou schopny operovat až do teploty -40~°C při poklesu kapacity z xxx na xxx mAh. S ohledem na teploty panující ve stratopauze, které klesají až k -60~°C, byl počet zvýšen na 10 ks, nechávající jistou rezervu. 

		\subsubsection{Připojení modulů}
		%Navrženy shieldy, nakresleny modely. Spínaný zdroj + LDO, ochrany vstupů, volné GPIO na rozšíření
		Ve vývojové fázi práce byly moduly zapojeny skrze nepájivé pole a propojeny propojovacími kabely s piny Nucleo desky. Moduly byly postupně přidávány s vývojem softwaru. Po odladění komunikace se všemi použitými moduly byly vytvořeny dvě redukční PCB na propojení Nucleo kitu a modulů. Moduly jsou vyobrazeny na obr. \ref{fig:shield:top} a \ref{fig:shield:bot}. 

		\begin{figure}[hbtp]
			\centering
			\begin{subfigure}{0.3\textwidth}
				\centering
				\includegraphics[height=0.7\linewidth]{Figures/shield_top.png} 
				\caption{Vrchní redukční deska}
				\label{fig:shield:top}
			\end{subfigure}%
			\begin{subfigure}{.3\textwidth}
				\centering
				\includegraphics[height=0.7\linewidth]{Figures/shield_bot.png}
				\caption{Vrchní redukční deska}
				\label{fig:shield:bot}
			\end{subfigure}
			\begin{subfigure}{.3\textwidth}
				\centering
				\includegraphics[height=0.7\linewidth]{Figures/shield_assembly.png}
				\caption{Sestava PCB}
				\label{fig:shield:assembly}
			\end{subfigure}
			\caption{Redukční desky pro moduly}
			\label{fig:shields}
		\end{figure}

		\subsubsection{Ochrana pinů}
		Jelikož většina pinů využívaných ke komunikaci byla snadno dostupná na dotyk při manipulaci, bylo potřeba je ošetřit vůči elektrostatickému výboji (ESD), který by měl za následek zničení čipu. Příklad ošetření GPIO pinů pomocí TVS diody BAV99 je na obr. \ref{fig:osetreni:vstupu}.
		
		\begin{figure}
			\centering
			\includegraphics[width = .7\textwidth]{Figures/osetreni_vstupu.png}
			\label{fig:osetreni:vstupu}
			\caption{Příklad ošetření vstupů TVS diodami}
		\end{figure}




	\section{Mechanická zástavba}

	Součástí práce je i mechanická zástavba kryt pro elektroniku. Pro přehlednost a optimální model krytu bylo potřeba vymodelovat i jednotlivé moduly. Kolem přesného 3D modelu elektroniky mohl být vymodelován kryt bez nutnosti čekat na výrobu redukčních desek.
	\begin{figure}[hbtp]
		\centering
		\begin{subfigure}{.5\textwidth}
			\centering
			\includegraphics[height=.7\linewidth]{Figures/modules_assembly.png} 
			\caption{Vymodelované moduly}
		\label{fig:modules:assembly}
		\end{subfigure}%
		\begin{subfigure}{.5\textwidth}
			\centering
			\includegraphics[height=.7\linewidth]{Figures/ALL_rez_LQ.png}
			\caption{Řez vrchní částí krytu sondy}
			\label{fig:all:rez}
		\end{subfigure}
		\label{fig:shields}
	\end{figure}

	
	Díky jednotlivým modelům bylo možné vytvořit kompletní model elektronické části, kolem kterého byl poté vymodelován kryt (obr. \ref{fig:all:rez}). Kryt byl modelován s ohledem na anténu umístěnou ve spodní části. Stěny kolem antény jsou ztenčené, aby co nejméně ovlivnily ladění antény na 868~MHz. Malá mechanická odolnost stěn je kompenzována čtyřmi výztužemi vedoucí po obvodu stěny.

	Pro splnění hmotnostního limitu byl model krytu postupně odlehčován. Při ubírání materiálu bylo nutné brát v potaz, že hlavní původ velké hmotnosti není při 3D tisku objem tělesa, ale jeho stěny. Při tvorbě otvorů v modelu se tedy neušetřila hmotnost odpovídající objemu válce odebraného ze stěny, ale pouze dvoum jeho podstavám. Naopak více materiálu bylo potřeba na plášť odebraného válce.

	TODO: názorný jednoduchý model s dírou a bez. 

	Připojení sondy ČHMÚ bylo provedeno pomocí gumového pásu, do kterého se zastrčila skoba odvíječe. To je zařízení, které zajistí postupné odmotání 50m lanka. 50~m je vzdálenost daná výrobcem, která musí být od balónu a dalších součástí sondy, aby byla zajištěna validní měření.

	V případě, že by došlo k delaminaci 3D tisku, byla jak elektronika, tak sonda ČHMÚ přivázána pojistným provázkem uchyceným k hlavnímu závěsu spolu s padákem a balónem. Díky tomu by sonda stále zůstala pohromadě i když by došlo k rozbití/rozlomení krytu.

	model PCB, model sondy, iterace, odlehčování, připojení sondy čhmú, bezpečnostní závěsy

	\section{Firmware}
	výstřizky kódu z driverů, sample GPS dat, vyčítání z teplota/tlak, tlak/vlhkost, gyro/acc/mag, parsovací funkce, změřené minimum accelerace v z-ose, sešití dat, watchdog, reset při erroru

	\section{Software}
	parsování příchozích dat, doplnění NMEA zprávy pro tracker, python - parsování a přepočítání souřadnic, zobrazení na mapě, zobrazení v terminálu

	\section{Testování a měření}
	směrová charakteristika, teplotní odolnost v klimakomoře, proudový odběr telitu, výlet na Říp, mapa viditelnosti z bodu na mapě. 




\chapter{Experiment}
příjem dat, umístění antény na střeš e , nastavení spektráku
	\section{Průběh experimentu}
	jak to probíhalo, co se stalo, proč sonda přestala vysílat, proč doletěla jen do 17 km, nalezení pomocí sondy čhmú, sundání sondy

	\section{Naměřená data}
	co bylo na SD kartě, výsledky měření - čístě změřená data



\chapter{Výsledky}
	\section{Zpracování dat}
	zkombinovat data ze země a data ze strato, vzorečky, určit refrakci, výkonovou bilanci podle podmínek, vzít v potaz směrovou charstiku. vyrobit model šíření, grafy

	\section{Výstup z experimentu}
	výsledky, co bylo změřeno a zjištěno



\chapter{Závěr}
	\section{Shrnutí experimentu}
	co se povedlo, co se nepovedlo. Vyrobil jsem sondu a sw, přestala vysílat - proč? 

	\section{Možná vylepšení}
	malé pcb bez modulů, optimalizace sw, nepoužívat HAL, programovat přes registry, měření náklonu sondy, častější posílání dat, nezávislost na GPS




\appendix

\printindex

\appendix

\bibliographystyle{amsalpha}
\bibliography{ctutest}

\ctutemplate{specification.as.chapter}

\end{document}

%vaisala datasheet https://www.vaisala.com/sites/default/files/documents/WEA-MET-RS41SGP-Datasheet-B211444EN.pdf